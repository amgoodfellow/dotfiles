#+TITLE: NAS Configuration

* Prerequisites

** Hardware Config
Save the output of the following to ~dotfiles/nas/hardware-configuration.nix~
#+begin_src shell :results output file :file hardware-configuration.nix
nixos-generate-config --show-hardware-config
#+end_src


** Networking ID
#+begin_src shell :results output file :file networking-id
head -c 8 /etc/machine-id
#+end_src


* Setting up the pool

It seems like it's easiest to set up the ZFS pool outside of nix, not declaratively.

#+begin_quote
[!NOTE]
In the future it might be nice to start using something like [[https://github.com/nix-community/disko/tree/master][disko]]
#+end_quote

1. Choose the name of the pool:
    #+begin_src shell :results output file :file pool-name
    echo "main-pool"
    #+end_src


2. Find all disks on the system
    #+begin_src bash
    ls -lh /dev/disk/by-id/
    #+end_src


3. Create the pool
   #+begin_src bash
    zpool create -f \
    -o ashift=12 \
    $(cat pool-name) \
    raidz2 /dev/disk/by-id/your-disk-1 ...
   #+end_src

   Ran command:
   #+begin_quote
   sudo zpool create -f -o ashift=12 $(cat pool-name) raidz2 $(cat disks-by-id)
   #+end_quote


4. Add a SLOG
    #+begin_src bash
    zpool add $(cat pool-name) log /dev/disk/by-id/your-ssd-id
    # You can add a mirror for redundancy
    # zpool add your-pool-name log mirror /dev/disk/by-id/device-1 /dev/disk/by-id/device-2
    #+end_src

5. Add a special device
    #+begin_src bash
    zpool add $(cat pool-name) special /dev/disk/by-id/your-ssd-id
    # To let the special device store small files
    sudo zfs set special_small_blocks=64K $(cat pool-name)
    #+end_src

** Datasets:
*** Immich
#+begin_src shell
zfs create -o atime=off -o recordsize=1M $(cat pool-name)/immich
#+end_src
*** Syncthing
#+begin_src shell
zfs create -o atime=off $(cat pool-name)/syncthing
#+end_src
*** Postgres
#+begin_src shell
zfs create -o atime=off -o recordsize=16k -o logbias=latency $(cat pool-name)/postgres
#+end_src
*** Borg
#+begin_src shell
zfs create -o atime=off -o recordsize=1M -o compression=off $(cat pool-name)/borg
#+end_src
*** ContainerD
#+begin_src shell
zfs create -o recordsize=16K -o atime=off -o xattr=sa -o logbias=latency -o mountpoint=/var/lib/rancher/k3s/agent/containerd/io.containerd.snapshotter.v1.zfs $(cat pool-name)/containerd
#+end_src
